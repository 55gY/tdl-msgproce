# 📤 JSON 文件上传转发指南

## 🎯 功能说明

Bot 现在支持直接接收 JSON 文件进行批量转发，无需在服务器上手动维护文件！

## ✨ 功能特点

- ✅ **直接发送文件** - 在 Telegram 中直接发送 .json 文件给 Bot
- ✅ **自动下载** - Bot 自动下载文件到临时目录
- ✅ **自动清理** - 转发完成或取消后自动删除临时文件
- ✅ **进度显示** - 实时显示转发进度
- ✅ **随时取消** - 可以随时终止转发任务
- ✅ **文件大小限制** - 最大支持 100MB

## 📝 使用步骤

### 1. 导出频道消息

使用 tdl 命令行工具导出消息：

```bash
# 导出频道 A 的所有消息到 JSON 文件
tdl chat export -c @channelA -o tdl-export.json
```

### 2. 发送文件到 Bot

1. 打开 Telegram
2. 找到你的 Bot
3. 直接发送 `tdl-export.json` 文件（作为文档发送）

### 3. Bot 处理流程

Bot 收到文件后会自动：

```
📥 正在下载文件: tdl-export.json
文件大小: 2.34 MB

请稍候...

✅ 文件下载成功
文件: tdl-export.json
大小: 2.34 MB

准备开始转发...

⚠️ 检测到文件路径转发任务

📌 注意事项：
• 大规模迁移可能需要数小时甚至数天
• 程序无超时限制，会持续运行直到完成
• 可随时点击按钮终止任务
• 建议保持程序稳定运行
• Bot 会定期更新进度（每30秒）
• 任务完成后将自动删除临时文件

即将开始执行...

📦 批次 #1 | 任务: 1/1

🔄 📁 #1 [转发中 45%] tdl-export.json

💡 大规模迁移进行中，请保持耐心...
```

### 4. 任务完成

```
📦 批次 #1 已完成

总计: 1个任务
✅ 成功: 1
⚠️ 失败: 0
❌ 取消: 0

耗时: 2h 34m 12s
```

临时文件会自动删除！

## 🆚 三种转发方式对比

| 方式 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **📤 直接发送文件** | 最方便，无需服务器维护，自动清理 | 需要下载时间 | ⭐⭐⭐⭐⭐ |
| 📝 发送文件路径 | 适合服务器上已有文件 | 需要手动管理文件 | ⭐⭐⭐ |
| 🔗 发送链接 | 适合单条或少量消息 | 不适合大规模迁移 | ⭐⭐⭐⭐ |

## 📋 文件要求

- ✅ 文件格式：`.json` (tdl 导出格式)
- ✅ 文件大小：最大 100 MB
- ✅ 编码格式：UTF-8
- ✅ 文件来源：tdl chat export 命令

## 🔧 技术细节

### 文件存储位置

```
./tdl_temp/tdl-export_1737379200_123456789.json
```

格式：`原文件名_时间戳_用户ID.json`

### 自动清理机制

- ✅ 任务完成后 2 秒自动删除
- ✅ 任务取消后自动删除
- ✅ 失败也会尝试删除
- ⚠️ 程序崩溃可能留下临时文件（需手动清理）

### 手动清理临时文件

如果遇到程序异常退出，可以手动清理：

```bash
# 删除所有临时文件
rm -rf ./tdl_temp/*.json

# 或删除整个临时目录
rm -rf ./tdl_temp
```

## ⚠️ 注意事项

1. **文件安全**
   - 仅接受 `.json` 文件
   - 文件大小限制 100MB
   - 仅允许授权用户上传

2. **网络要求**
   - 需要稳定的网络连接
   - 下载大文件可能需要时间
   - 建议使用有线网络

3. **服务器空间**
   - 确保有足够的临时存储空间
   - 每个文件会在 `./tdl_temp/` 目录
   - 文件会自动清理

4. **长时间任务**
   - 保持程序运行
   - 不要关闭服务器
   - 可以随时查看进度

## 🐛 故障排查

### 问题：文件下载失败

```
解决方案：
1. 检查网络连接
2. 确认 Bot Token 正确
3. 检查文件大小是否超过 100MB
4. 重新发送文件
```

### 问题：转发中断

```
解决方案：
1. 检查服务器是否运行
2. 查看日志文件
3. 重新发送文件继续转发
4. tdl 支持断点续传
```

### 问题：临时文件未删除

```
解决方案：
手动清理：
cd /path/to/tdl-msgproce
rm -rf ./tdl_temp/*.json
```

## 💡 最佳实践

1. **大文件分批处理**
   ```bash
   # 导出时按日期范围分批
   tdl chat export -c @channel --from 2024-01-01 --to 2024-01-31 -o jan.json
   tdl chat export -c @channel --from 2024-02-01 --to 2024-02-29 -o feb.json
   ```

2. **监控转发进度**
   - Bot 每 30 秒更新一次进度
   - 可以通过日志查看详细信息

3. **备份重要数据**
   - 转发前备份源频道
   - 保存导出的 JSON 文件

## 🚀 示例：完整迁移流程

```bash
# 1. 导出源频道消息
tdl chat export -c @source_channel -o export.json

# 2. 在 Telegram 中发送 export.json 文件给 Bot

# 3. Bot 自动：
#    - 下载文件到 ./tdl_temp/
#    - 开始转发到目标频道
#    - 显示实时进度
#    - 完成后删除临时文件

# 4. 完成！
```

## 📞 需要帮助？

- 使用 `/help` 命令查看帮助
- 使用 `/status` 命令查看运行状态
- 查看日志文件排查问题
- 参考 README.md 了解更多

---

**提示：直接发送 JSON 文件是最推荐的方式！** 🎉
